import { Injectable } from '@angular/core';
import { SplitFactory } from '@splitsoftware/splitio-browserjs';
import { from, Observable } from 'rxjs';
import { INIT_CLIENT_EXISTS, INIT_CLIENT_FIRST, CONTROL_CLIENT, DEFAULT_MANAGER, VERSION } from './utils/constants';
import { buildInstance, parseTrackParams, parseTreatmentParams } from './utils/utils';
import * as i0 from "@angular/core";
export class SplitService {
    constructor() {
        /**
         * Map of intialized clients
         */
        this.clientsMap = new Map();
        /**
         * Map of events status of intialized clients
         */
        this.emittedEvents = new Map();
        /**
         * Flag to determine if SDK is ready or not.
         */
        this.isSDKReady = false;
    }
    /**
     * This method initializes the SDK with the required Browser APIKEY
     * and the 'key' according to the Traffic type set (ex.: an user id).
     * @function init
     * @param {IBrowserSettings} config Should be an object that complies with the SplitIO.IBrowserSettings.
     * @returns {Observable<string>} Returns when sdk is ready
     */
    init(config) {
        if (this.splitio) {
            console.log('[ERROR] There is another instance of the SDK.');
            return new Observable(observer => observer.error(INIT_CLIENT_EXISTS));
        }
        this.config = config;
        // @ts-ignore. 2nd param is not part of type definitions. Used to overwrite the version of the SDK for correct tracking.
        this.splitio = SplitFactory(config, (modules) => {
            modules.settings.version = VERSION;
        });
        this.splitClient = this.splitio.client();
        this.splitManager = this.splitio.manager();
        this.sdkInitEventObservable();
        const instanceKey = buildInstance(this.config.core.key);
        const sdkReady = this.splitClient.Event.SDK_READY;
        this.splitClient.on(sdkReady, () => {
            this.emittedEvents.set(instanceKey + sdkReady, true);
            this.isSDKReady = true;
        });
        this.clientsMap.set(instanceKey, this.splitClient);
        return this.sdkReady$;
    }
    /**
     * Returns a shared client of the SDK, associated with the given key
     * @function initClient
     * @param {SplitKey} key The key for the new client instance.
     * @returns {Observable<string>} Returns when sdk is ready
     */
    initClient(key) {
        let client = this.getSDKClient(key);
        if (client) {
            console.log('[WARN] client for key ' + buildInstance(key) + ' is already initialized.');
            return new Observable(observer => observer.error(INIT_CLIENT_EXISTS));
        }
        if (!this.splitio)
            return new Observable(observer => observer.error(INIT_CLIENT_FIRST));
        client = this.splitio.client(key);
        this.clientsMap.set(buildInstance(key), client);
        return this.toObservable(key, client, client.Event.SDK_READY);
    }
    getClientObservable(key, event, isOneTimeEvent = true) {
        const client = this.getClient(key);
        if (client === CONTROL_CLIENT) {
            return new Observable(observer => observer.error(INIT_CLIENT_FIRST));
        }
        return this.toObservable(key, client, client.Event[event], isOneTimeEvent);
    }
    /**
     * Returns an observable that calls back when the client is ready
     * @function getClientSDKReady
     * @param {SplitKey} key The key for the client instance.
     * @returns {Observable<string>}
     */
    getClientSDKReady(key) {
        return this.getClientObservable(key, 'SDK_READY');
    }
    /**
     * Returns an observable that calls back when the client ready event is timed out
     * @function getClientSDKReadyTimedOut
     * @param {SplitKey} key The key for the client instance.
     * @returns {Observable<string>}
     */
    getClientSDKReadyTimedOut(key) {
        return this.getClientObservable(key, 'SDK_READY_TIMED_OUT');
    }
    /**
     * Returns an observable that calls back when the client is ready from cache
     * @function getClientSDKReadyFromCache
     * @param {SplitKey} key The key for the client instance.
     * @returns {Observable<string>}
     */
    getClientSDKReadyFromCache(key) {
        return this.getClientObservable(key, 'SDK_READY_FROM_CACHE');
    }
    /**
     * Returns an observable that calls back when the client is updated
     * @function getClientSDKUpdate
     * @param {SplitKey} key The key for the client instance.
     * @returns {Observable<string>}
     */
    getClientSDKUpdate(key) {
        return this.getClientObservable(key, 'SDK_UPDATE', false);
    }
    /**
     * initialize sdk Events into observables
     */
    sdkInitEventObservable() {
        const client = this.splitClient;
        const mainKey = this.config.core.key;
        this.sdkReady$ = this.toObservable(mainKey, client, client.Event.SDK_READY);
        this.sdkReadyTimedOut$ = this.toObservable(mainKey, client, client.Event.SDK_READY_TIMED_OUT);
        this.sdkReadyFromCache$ = this.toObservable(mainKey, client, client.Event.SDK_READY_FROM_CACHE);
        this.sdkUpdate$ = this.toObservable(mainKey, client, client.Event.SDK_UPDATE, false);
    }
    /**
     * Returns a promise that will be resolved once the SDK has finished loading (SDK_READY event emitted) or rejected if the SDK has timedout (SDK_READY_TIMED_OUT event emitted).
     * As it's meant to provide similar flexibility to the event approach, given that the SDK might be eventually ready after a timeout event,
     * calling the ready method after the SDK had timed out will return a new promise that should eventually resolve if the SDK gets ready.
     * @returns Promise<void>
     */
    ready() {
        return this.getClient().ready();
    }
    isInitialized() {
        if (!this.splitio) {
            console.log('[ERROR] plugin should be initialized');
            return false;
        }
        return true;
    }
    /**
     * Returns the SDK client
     * @param {SplitKey=} key The key for the client instance.
     * @returns {IClient} split client.
     */
    getSDKClient(key) {
        if (!this.isInitialized())
            return undefined;
        key = key ? key : this.config.core.key;
        return this.clientsMap.get(buildInstance(key));
    }
    /**
     * Returns the SDK factory
     * @returns {ISDK} split factory
     */
    getSDKFactory() {
        if (!this.isInitialized())
            return undefined;
        return this.splitio;
    }
    /**
     * Validates key and returns client if it is initialized for key or controlClient if it isn't
     */
    getClient(key) {
        const client = this.getSDKClient(key);
        if (!client) {
            console.log('[ERROR] client' + (key ? ' for key ' + buildInstance(key) : '') + ' should be initialized first.');
            return CONTROL_CLIENT;
        }
        return client;
    }
    getTreatment(param1, param2, param3) {
        const { key, splitNames, attributes } = parseTreatmentParams(param1, param2, param3);
        return this.getClient(key).getTreatment(splitNames, attributes);
    }
    getTreatmentWithConfig(param1, param2, param3) {
        const { key, splitNames, attributes } = parseTreatmentParams(param1, param2, param3);
        return this.getClient(key).getTreatmentWithConfig(splitNames, attributes);
    }
    getTreatments(param1, param2, param3) {
        const { key, splitNames, attributes } = parseTreatmentParams(param1, param2, param3);
        return this.getClient(key).getTreatments(splitNames, attributes);
    }
    getTreatmentsWithConfig(param1, param2, param3) {
        const { key, splitNames, attributes } = parseTreatmentParams(param1, param2, param3);
        return this.getClient(key).getTreatmentsWithConfig(splitNames, attributes);
    }
    track(param1, param2, param3, param4, param5) {
        const { key, trafficType, eventType, value, properties } = parseTrackParams(param1, param2, param3, param4, param5);
        return this.getClient(key).track(trafficType, eventType, value, properties);
    }
    /**
     * Validates key and returns client if it is initialized for key or controlClient if it isn't
     */
    getManager() {
        const client = this.getSDKClient();
        if (!client) {
            console.log('[ERROR] The SDK has not being initialized. Returning default response for method call.');
            return DEFAULT_MANAGER;
        }
        return this.splitManager;
    }
    /**
     * Get the array of splits data in SplitView format.
     * @function getSplits
     * @returns {SplitViews} The list of SplitIO.SplitView.
     */
    getSplits() {
        return this.getManager().splits();
    }
    /**
     * Get the data of a split in SplitView format.
     * @function getSplit
     * @param {string} splitName The name of the split we wan't to get info of.
     * @returns {SplitView} The SplitIO.SplitView of the given split.
     */
    getSplit(splitName) {
        return this.getManager().split(splitName);
    }
    /**
     * Get the array of Split names.
     * @function getSplitNames
     * @returns {SplitNames} The lists of Split names.
     */
    getSplitNames() {
        return this.getManager().names();
    }
    /**
     * Destroy all clients instances.
     * @function destroy
     * @returns {Observable<unknown>}
     */
    destroy() {
        const mainInstanceKey = buildInstance(this.config.core.key);
        this.clientsMap.forEach((client, key) => {
            if (buildInstance(key) !== mainInstanceKey) {
                client.destroy();
                this.clientsMap.delete(buildInstance(key));
            }
        });
        this.clientsMap.delete(mainInstanceKey);
        this.splitio = undefined;
        return from(this.splitClient.destroy());
    }
    /**
     * Private function to return as observable the event on parameter
     * @param {string} event
     * @param response
     * @returns Observable<any>
     */
    toObservable(key, client, event, isOneTimeEvent = true) {
        const eventKey = buildInstance(key) + event;
        if (isOneTimeEvent) {
            return new Observable(subscriber => {
                const wasEventEmitted = this.emittedEvents.get(eventKey);
                if (wasEventEmitted) {
                    Promise.resolve().then(() => subscriber.next(event));
                }
                else {
                    client.once(event, () => {
                        this.emittedEvents.set(eventKey, true);
                        subscriber.next(event);
                    });
                }
            });
        }
        else {
            return new Observable(subscriber => {
                client.on(event, () => {
                    subscriber.next(event);
                });
            });
        }
    }
}
SplitService.ɵprov = i0.ɵɵdefineInjectable({ factory: function SplitService_Factory() { return new SplitService(); }, token: SplitService, providedIn: "root" });
SplitService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BsaXRpby5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9lbW1hbnVlbHphbW9yYS9zcGxpdC9hbmd1bGFyLXNkay1wbHVnaW4vcHJvamVjdHMvc3BsaXRpby9zcmMvIiwic291cmNlcyI6WyJsaWIvc3BsaXRpby5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRWhFLE9BQU8sRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3hDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BILE9BQU8sRUFBRSxhQUFhLEVBQUUsZ0JBQWdCLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxlQUFlLENBQUM7O0FBS3RGLE1BQU0sT0FBTyxZQUFZO0lBSHpCO1FBaUJFOztXQUVHO1FBQ0ssZUFBVSxHQUFpQyxJQUFJLEdBQUcsRUFBMkIsQ0FBQztRQUN0Rjs7V0FFRztRQUNLLGtCQUFhLEdBQXlCLElBQUksR0FBRyxFQUFtQixDQUFDO1FBQ3pFOztXQUVHO1FBQ0gsZUFBVSxHQUFHLEtBQUssQ0FBQztLQW9YcEI7SUF2V0M7Ozs7OztPQU1HO0lBQ0gsSUFBSSxDQUFDLE1BQWdDO1FBQ25DLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixPQUFPLENBQUMsR0FBRyxDQUFDLCtDQUErQyxDQUFDLENBQUM7WUFDN0QsT0FBTyxJQUFJLFVBQVUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO1NBQ3ZFO1FBQ0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsd0hBQXdIO1FBQ3hI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LENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBQ3ZDLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ3pCLENBQUMsQ0FBQyxDQUFDO2lCQUNKO1lBQ0gsQ0FBQyxDQUFDLENBQUM7U0FDSjthQUFNO1lBQ0wsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFVLENBQUMsRUFBRTtnQkFDakMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFO29CQUNwQixVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN6QixDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDOzs7O1lBOVlGLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFNwbGl0RmFjdG9yeSB9IGZyb20gJ0BzcGxpdHNvZnR3YXJlL3NwbGl0aW8tYnJvd3NlcmpzJztcbmltcG9ydCAqIGFzIFNwbGl0SU8gZnJvbSAnQHNwbGl0c29mdHdhcmUvc3BsaXRpby1icm93c2VyanMvdHlwZXMvc3BsaXRpbyc7XG5pbXBvcnQgeyBmcm9tLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBJTklUX0NMSUVOVF9FWElTVFMsIElOSVRfQ0xJRU5UX0ZJUlNULCBDT05UUk9MX0NMSUVOVCwgREVGQVVMVF9NQU5BR0VSLCBWRVJTSU9OIH0gZnJvbSAnLi91dGlscy9jb25zdGFudHMnO1xuaW1wb3J0IHsgYnVpbGRJbnN0YW5jZSwgcGFyc2VUcmFja1BhcmFtcywgcGFyc2VUcmVhdG1lbnRQYXJhbXMgfSBmcm9tICcuL3V0aWxzL3V0aWxzJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgU3BsaXRTZXJ2aWNlIHtcblxuICAvKipcbiAgICogVGhlIGxvY2FsIHJlZmVyZW5jZSB0byB0aGUgU3BsaXQgU0RLLlxuICAgKi9cbiAgcHJpdmF0ZSBzcGxpdGlvOiBTcGxpdElPLklTREsgfCB1bmRlZmluZWQ7XG4gIC8qKlxuICAgKiBUaGUgbG9jYWwgcmVmZXJlbmNlIHRvIHRoZSBTcGxpdCBTREsncyBDbGllbnQuXG4gICAqL1xuICBwcml2YXRlIHNwbGl0Q2xpZW50OiBTcGxpdElPLklDbGllbnQ7XG4gIC8qKlxuICAgKiBUaGUgbG9jYWwgcmVmZXJlbmNlIHRvIHRoZSBTcGxpdCBTREsncyBNYW5hZ2VyLlxuICAgKi9cbiAgcHJpdmF0ZSBzcGxpdE1hbmFnZXI6IFNwbGl0SU8uSU1hbmFnZXI7XG4gIC8qKlxuICAgKiBNYXAgb2YgaW50aWFsaXplZCBjbGllbnRzXG4gICAqL1xuICBwcml2YXRlIGNsaWVudHNNYXA6IE1hcDxzdHJpbmcsIFNwbGl0SU8uSUNsaWVudD4gPSBuZXcgTWFwPHN0cmluZywgU3BsaXRJTy5JQ2xpZW50PigpO1xuICAvKipcbiAgICogTWFwIG9mIGV2ZW50cyBzdGF0dXMgb2YgaW50aWFsaXplZCBjbGllbnRzXG4gICAqL1xuICBwcml2YXRlIGVtaXR0ZWRFdmVudHM6IE1hcDxzdHJpbmcsIGJvb2xlYW4+ID0gbmV3IE1hcDxzdHJpbmcsIGJvb2xlYW4+KCk7XG4gIC8qKlxuICAgKiBGbGFnIHRvIGRldGVybWluZSBpZiBTREsgaXMgcmVhZHkgb3Igbm90LlxuICAgKi9cbiAgaXNTREtSZWFkeSA9IGZhbHNlO1xuICAvKipcbiAgICogRmFjdG9yeSBjb25maWdcbiAgICovXG4gIHByaXZhdGUgY29uZmlnOiBTcGxpdElPLklCcm93c2VyU2V0dGluZ3M7XG4gIC8qKlxuICAgKiBTREsgZXZlbnRzIG9ic2VydmFibGVzXG4gICAqL1xuICBzZGtSZWFkeSQ6IE9ic2VydmFibGU8c3RyaW5nPjtcbiAgc2RrUmVhZHlUaW1lZE91dCQ6IE9ic2VydmFibGU8c3RyaW5nPjtcbiAgc2RrUmVhZHlGcm9tQ2FjaGUkOiBPYnNlcnZhYmxlPHN0cmluZz47XG4gIHNka1VwZGF0ZSQ6IE9ic2VydmFibGU8c3RyaW5nPjtcblxuICAvKipcbiAgICogVGhpcyBtZXRob2QgaW5pdGlhbGl6ZXMgdGhlIFNESyB3aXRoIHRoZSByZXF1aXJlZCBCcm93c2VyIEFQSUtFWVxuICAgKiBhbmQgdGhlICdrZXknIGFjY29yZGluZyB0byB0aGUgVHJhZmZpYyB0eXBlIHNldCAoZXguOiBhbiB1c2VyIGlkKS5cbiAgICogQGZ1bmN0aW9uIGluaXRcbiAgICogQHBhcmFtIHtJQnJvd3NlclNldHRpbmdzfSBjb25maWcgU2hvdWxkIGJlIGFuIG9iamVjdCB0aGF0IGNvbXBsaWVzIHdpdGggdGhlIFNwbGl0SU8uSUJyb3dzZXJTZXR0aW5ncy5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8c3RyaW5nPn0gUmV0dXJucyB3aGVuIHNkayBpcyByZWFkeVxuICAgKi9cbiAgaW5pdChjb25maWc6IFNwbGl0SU8uSUJyb3dzZXJTZXR0aW5ncyk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgaWYgKHRoaXMuc3BsaXRpbykge1xuICAgICAgY29uc29sZS5sb2coJ1tFUlJPUl0gVGhlcmUgaXMgYW5vdGhlciBpbnN0YW5jZSBvZiB0aGUgU0RLLicpO1xuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9ic2VydmVyID0+IG9ic2VydmVyLmVycm9yKElOSVRfQ0xJRU5UX0VYSVNUUykpO1xuICAgIH1cbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAvLyBAdHMtaWdub3JlLiAybmQgcGFyYW0gaXMgbm90IHBhcnQgb2YgdHlwZSBkZWZpbml0aW9ucy4gVXNlZCB0byBvdmVyd3JpdGUgdGhlIHZlcnNpb24gb2YgdGhlIFNESyBmb3IgY29ycmVjdCB0cmFja2luZy5cbiAgICB0aGlzLnNwbGl0aW8gPSBTcGxpdEZhY3RvcnkoY29uZmlnLCAobW9kdWxlcykgPT4ge1xuICAgICAgbW9kdWxlcy5zZXR0aW5ncy52ZXJzaW9uID0gVkVSU0lPTjtcbiAgICB9KTtcbiAgICB0aGlzLnNwbGl0Q2xpZW50ID0gdGhpcy5zcGxpdGlvLmNsaWVudCgpO1xuICAgIHRoaXMuc3BsaXRNYW5hZ2VyID0gdGhpcy5zcGxpdGlvLm1hbmFnZXIoKTtcbiAgICB0aGlzLnNka0luaXRFdmVudE9ic2VydmFibGUoKTtcbiAgICBjb25zdCBpbnN0YW5jZUtleSA9IGJ1aWxkSW5zdGFuY2UodGhpcy5jb25maWcuY29yZS5rZXkpO1xuICAgIGNvbnN0IHNka1JlYWR5ID0gdGhpcy5zcGxpdENsaWVudC5FdmVudC5TREtfUkVBRFk7XG4gICAgdGhpcy5zcGxpdENsaWVudC5vbihzZGtSZWFkeSwgKCkgPT4ge1xuICAgICAgdGhpcy5lbWl0dGVkRXZlbnRzLnNldChpbnN0YW5jZUtleSArIHNka1JlYWR5LCB0cnVlKTtcbiAgICAgIHRoaXMuaXNTREtSZWFkeSA9IHRydWU7XG4gICAgfSk7XG4gICAgdGhpcy5jbGllbnRzTWFwLnNldChpbnN0YW5jZUtleSwgdGhpcy5zcGxpdENsaWVudCk7XG4gICAgcmV0dXJuIHRoaXMuc2RrUmVhZHkkO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBzaGFyZWQgY2xpZW50IG9mIHRoZSBTREssIGFzc29jaWF0ZWQgd2l0aCB0aGUgZ2l2ZW4ga2V5XG4gICAqIEBmdW5jdGlvbiBpbml0Q2xpZW50XG4gICAqIEBwYXJhbSB7U3BsaXRLZXl9IGtleSBUaGUga2V5IGZvciB0aGUgbmV3IGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8c3RyaW5nPn0gUmV0dXJucyB3aGVuIHNkayBpcyByZWFkeVxuICAgKi9cbiAgaW5pdENsaWVudChrZXk6IFNwbGl0SU8uU3BsaXRLZXkpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGxldCBjbGllbnQgPSB0aGlzLmdldFNES0NsaWVudChrZXkpO1xuICAgIGlmIChjbGllbnQpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdbV0FSTl0gY2xpZW50IGZvciBrZXkgJyArIGJ1aWxkSW5zdGFuY2Uoa2V5KSArICcgaXMgYWxyZWFkeSBpbml0aWFsaXplZC4nKTtcbiAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiBvYnNlcnZlci5lcnJvcihJTklUX0NMSUVOVF9FWElTVFMpKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLnNwbGl0aW8pIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnNlcnZlciA9PiBvYnNlcnZlci5lcnJvcihJTklUX0NMSUVOVF9GSVJTVCkpO1xuICAgIGNsaWVudCA9IHRoaXMuc3BsaXRpby5jbGllbnQoa2V5KTtcbiAgICB0aGlzLmNsaWVudHNNYXAuc2V0KGJ1aWxkSW5zdGFuY2Uoa2V5KSwgY2xpZW50KTtcbiAgICByZXR1cm4gdGhpcy50b09ic2VydmFibGUoa2V5LCBjbGllbnQsIGNsaWVudC5FdmVudC5TREtfUkVBRFkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDbGllbnRPYnNlcnZhYmxlKGtleTogU3BsaXRJTy5TcGxpdEtleSwgZXZlbnQ6IHN0cmluZywgaXNPbmVUaW1lRXZlbnQgPSB0cnVlKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldENsaWVudChrZXkpO1xuICAgIGlmIChjbGllbnQgPT09IENPTlRST0xfQ0xJRU5UKSB7XG4gICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzZXJ2ZXIgPT4gb2JzZXJ2ZXIuZXJyb3IoSU5JVF9DTElFTlRfRklSU1QpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMudG9PYnNlcnZhYmxlKGtleSwgY2xpZW50LCBjbGllbnQuRXZlbnRbZXZlbnRdLCBpc09uZVRpbWVFdmVudCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhbiBvYnNlcnZhYmxlIHRoYXQgY2FsbHMgYmFjayB3aGVuIHRoZSBjbGllbnQgaXMgcmVhZHlcbiAgICogQGZ1bmN0aW9uIGdldENsaWVudFNES1JlYWR5XG4gICAqIEBwYXJhbSB7U3BsaXRLZXl9IGtleSBUaGUga2V5IGZvciB0aGUgY2xpZW50IGluc3RhbmNlLlxuICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxzdHJpbmc+fVxuICAgKi9cbiAgZ2V0Q2xpZW50U0RLUmVhZHkoa2V5OiBTcGxpdElPLlNwbGl0S2V5KTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnRPYnNlcnZhYmxlKGtleSwgJ1NES19SRUFEWScpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gb2JzZXJ2YWJsZSB0aGF0IGNhbGxzIGJhY2sgd2hlbiB0aGUgY2xpZW50IHJlYWR5IGV2ZW50IGlzIHRpbWVkIG91dFxuICAgKiBAZnVuY3Rpb24gZ2V0Q2xpZW50U0RLUmVhZHlUaW1lZE91dFxuICAgKiBAcGFyYW0ge1NwbGl0S2V5fSBrZXkgVGhlIGtleSBmb3IgdGhlIGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8c3RyaW5nPn1cbiAgICovXG4gIGdldENsaWVudFNES1JlYWR5VGltZWRPdXQoa2V5OiBTcGxpdElPLlNwbGl0S2V5KTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnRPYnNlcnZhYmxlKGtleSwgJ1NES19SRUFEWV9USU1FRF9PVVQnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGFuIG9ic2VydmFibGUgdGhhdCBjYWxscyBiYWNrIHdoZW4gdGhlIGNsaWVudCBpcyByZWFkeSBmcm9tIGNhY2hlXG4gICAqIEBmdW5jdGlvbiBnZXRDbGllbnRTREtSZWFkeUZyb21DYWNoZVxuICAgKiBAcGFyYW0ge1NwbGl0S2V5fSBrZXkgVGhlIGtleSBmb3IgdGhlIGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8c3RyaW5nPn1cbiAgICovXG4gIGdldENsaWVudFNES1JlYWR5RnJvbUNhY2hlKGtleTogU3BsaXRJTy5TcGxpdEtleSk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q2xpZW50T2JzZXJ2YWJsZShrZXksICdTREtfUkVBRFlfRlJPTV9DQUNIRScpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYW4gb2JzZXJ2YWJsZSB0aGF0IGNhbGxzIGJhY2sgd2hlbiB0aGUgY2xpZW50IGlzIHVwZGF0ZWRcbiAgICogQGZ1bmN0aW9uIGdldENsaWVudFNES1VwZGF0ZVxuICAgKiBAcGFyYW0ge1NwbGl0S2V5fSBrZXkgVGhlIGtleSBmb3IgdGhlIGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHJldHVybnMge09ic2VydmFibGU8c3RyaW5nPn1cbiAgICovXG4gIGdldENsaWVudFNES1VwZGF0ZShrZXk6IFNwbGl0SU8uU3BsaXRLZXkpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLmdldENsaWVudE9ic2VydmFibGUoa2V5LCAnU0RLX1VQREFURScsIGZhbHNlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBpbml0aWFsaXplIHNkayBFdmVudHMgaW50byBvYnNlcnZhYmxlc1xuICAgKi9cbiAgcHJpdmF0ZSBzZGtJbml0RXZlbnRPYnNlcnZhYmxlKCk6IHZvaWQge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuc3BsaXRDbGllbnQ7XG4gICAgY29uc3QgbWFpbktleSA9IHRoaXMuY29uZmlnLmNvcmUua2V5O1xuICAgIHRoaXMuc2RrUmVhZHkkID0gdGhpcy50b09ic2VydmFibGUobWFpbktleSwgY2xpZW50LCBjbGllbnQuRXZlbnQuU0RLX1JFQURZKTtcbiAgICB0aGlzLnNka1JlYWR5VGltZWRPdXQkID0gdGhpcy50b09ic2VydmFibGUobWFpbktleSwgY2xpZW50LCBjbGllbnQuRXZlbnQuU0RLX1JFQURZX1RJTUVEX09VVCk7XG4gICAgdGhpcy5zZGtSZWFkeUZyb21DYWNoZSQgPSB0aGlzLnRvT2JzZXJ2YWJsZShtYWluS2V5LCBjbGllbnQsIGNsaWVudC5FdmVudC5TREtfUkVBRFlfRlJPTV9DQUNIRSk7XG4gICAgdGhpcy5zZGtVcGRhdGUkID0gdGhpcy50b09ic2VydmFibGUobWFpbktleSwgY2xpZW50LCBjbGllbnQuRXZlbnQuU0RLX1VQREFURSwgZmFsc2UpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBwcm9taXNlIHRoYXQgd2lsbCBiZSByZXNvbHZlZCBvbmNlIHRoZSBTREsgaGFzIGZpbmlzaGVkIGxvYWRpbmcgKFNES19SRUFEWSBldmVudCBlbWl0dGVkKSBvciByZWplY3RlZCBpZiB0aGUgU0RLIGhhcyB0aW1lZG91dCAoU0RLX1JFQURZX1RJTUVEX09VVCBldmVudCBlbWl0dGVkKS5cbiAgICogQXMgaXQncyBtZWFudCB0byBwcm92aWRlIHNpbWlsYXIgZmxleGliaWxpdHkgdG8gdGhlIGV2ZW50IGFwcHJvYWNoLCBnaXZlbiB0aGF0IHRoZSBTREsgbWlnaHQgYmUgZXZlbnR1YWxseSByZWFkeSBhZnRlciBhIHRpbWVvdXQgZXZlbnQsXG4gICAqIGNhbGxpbmcgdGhlIHJlYWR5IG1ldGhvZCBhZnRlciB0aGUgU0RLIGhhZCB0aW1lZCBvdXQgd2lsbCByZXR1cm4gYSBuZXcgcHJvbWlzZSB0aGF0IHNob3VsZCBldmVudHVhbGx5IHJlc29sdmUgaWYgdGhlIFNESyBnZXRzIHJlYWR5LlxuICAgKiBAcmV0dXJucyBQcm9taXNlPHZvaWQ+XG4gICAqL1xuICByZWFkeSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnQoKS5yZWFkeSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0luaXRpYWxpemVkKCk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5zcGxpdGlvKSB7XG4gICAgICBjb25zb2xlLmxvZygnW0VSUk9SXSBwbHVnaW4gc2hvdWxkIGJlIGluaXRpYWxpemVkJyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgdGhlIFNESyBjbGllbnRcbiAgICogQHBhcmFtIHtTcGxpdEtleT19IGtleSBUaGUga2V5IGZvciB0aGUgY2xpZW50IGluc3RhbmNlLlxuICAgKiBAcmV0dXJucyB7SUNsaWVudH0gc3BsaXQgY2xpZW50LlxuICAgKi9cbiAgZ2V0U0RLQ2xpZW50KGtleT86IFNwbGl0SU8uU3BsaXRLZXkpOiBTcGxpdElPLklDbGllbnQgfCB1bmRlZmluZWQge1xuICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKCkpIHJldHVybiB1bmRlZmluZWQ7XG4gICAga2V5ID0ga2V5ID8ga2V5IDogdGhpcy5jb25maWcuY29yZS5rZXk7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50c01hcC5nZXQoYnVpbGRJbnN0YW5jZShrZXkpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBTREsgZmFjdG9yeVxuICAgKiBAcmV0dXJucyB7SVNES30gc3BsaXQgZmFjdG9yeVxuICAgKi9cbiAgZ2V0U0RLRmFjdG9yeSgpOiBTcGxpdElPLklTREsgfCB1bmRlZmluZWQge1xuICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKCkpIHJldHVybiB1bmRlZmluZWQ7XG4gICAgcmV0dXJuIHRoaXMuc3BsaXRpbztcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMga2V5IGFuZCByZXR1cm5zIGNsaWVudCBpZiBpdCBpcyBpbml0aWFsaXplZCBmb3Iga2V5IG9yIGNvbnRyb2xDbGllbnQgaWYgaXQgaXNuJ3RcbiAgICovXG4gIHByaXZhdGUgZ2V0Q2xpZW50KGtleT86IFNwbGl0SU8uU3BsaXRLZXkgfCB1bmRlZmluZWQpOiBhbnkge1xuICAgIGNvbnN0IGNsaWVudCA9IHRoaXMuZ2V0U0RLQ2xpZW50KGtleSk7XG4gICAgaWYgKCFjbGllbnQpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdbRVJST1JdIGNsaWVudCcgKyAoIGtleSA/ICcgZm9yIGtleSAnICsgYnVpbGRJbnN0YW5jZShrZXkpIDogJycpICsgJyBzaG91bGQgYmUgaW5pdGlhbGl6ZWQgZmlyc3QuJyk7XG4gICAgICByZXR1cm4gQ09OVFJPTF9DTElFTlQ7XG4gICAgfVxuICAgIHJldHVybiBjbGllbnQ7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIFRyZWF0bWVudCB2YWx1ZSwgd2hpY2ggaXMgdGhlIHRyZWF0bWVudCBzdHJpbmcgZm9yIHRoZSBnaXZlbiBmZWF0dXJlLlxuICAgKiBAZnVuY3Rpb24gZ2V0VHJlYXRtZW50XG4gICAqIEBwYXJhbSB7U3BsaXRLZXl9IGtleSAtIFRoZSBrZXkgZm9yIHRoZSBjbGllbnQgaW5zdGFuY2UuXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzcGxpdE5hbWUgLSBUaGUgc3RyaW5nIHRoYXQgcmVwcmVzZW50cyB0aGUgc3BsaXQgd2Ugd2FudCB0byBnZXQgdGhlIHRyZWF0bWVudC5cbiAgICogQHBhcmFtIHtBdHRyaWJ1dGVzPX0gYXR0cmlidXRlcyAtIEFuIG9iamVjdCBvZiB0eXBlIEF0dHJpYnV0ZXMgZGVmaW5pbmcgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAqIEByZXR1cm5zIHtUcmVhdG1lbnR9IC0gVGhlIHRyZWF0bWVudCBzdHJpbmcuXG4gICAqL1xuICBnZXRUcmVhdG1lbnQoa2V5OiBTcGxpdElPLlNwbGl0S2V5LCBzcGxpdE5hbWU6IHN0cmluZywgYXR0cmlidXRlcz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50O1xuICAvKipcbiAgICogUmV0dXJucyBhIFRyZWF0bWVudCB2YWx1ZSwgd2hpY2ggaXMgdGhlIHRyZWF0bWVudCBzdHJpbmcgZm9yIHRoZSBnaXZlbiBmZWF0dXJlLlxuICAgKiBAZnVuY3Rpb24gZ2V0VHJlYXRtZW50XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzcGxpdE5hbWUgLSBUaGUgc3RyaW5nIHRoYXQgcmVwcmVzZW50cyB0aGUgc3BsaXQgd2Ugd2FudCB0byBnZXQgdGhlIHRyZWF0bWVudC5cbiAgICogQHBhcmFtIHtBdHRyaWJ1dGVzPX0gYXR0cmlidXRlcyAtIEFuIG9iamVjdCBvZiB0eXBlIEF0dHJpYnV0ZXMgZGVmaW5pbmcgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAqIEByZXR1cm5zIHtUcmVhdG1lbnR9IC0gVGhlIHRyZWF0bWVudCBzdHJpbmcuXG4gICAqL1xuICBnZXRUcmVhdG1lbnQoc3BsaXROYW1lOiBzdHJpbmcsIGF0dHJpYnV0ZXM/OiBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQpOiBTcGxpdElPLlRyZWF0bWVudDtcbiAgZ2V0VHJlYXRtZW50KHBhcmFtMTogc3RyaW5nIHwgU3BsaXRJTy5TcGxpdEtleSwgcGFyYW0yPzogc3RyaW5nIHwgU3BsaXRJTy5BdHRyaWJ1dGVzIHwgdW5kZWZpbmVkLCBwYXJhbTM/OiBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQpOiBTcGxpdElPLlRyZWF0bWVudCB7XG4gICAgY29uc3Qge2tleSwgc3BsaXROYW1lcywgYXR0cmlidXRlc30gPSBwYXJzZVRyZWF0bWVudFBhcmFtcyhwYXJhbTEsIHBhcmFtMiwgcGFyYW0zKTtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnQoa2V5KS5nZXRUcmVhdG1lbnQoc3BsaXROYW1lcywgYXR0cmlidXRlcyk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyBhIFRyZWF0bWVudFdpdGhDb25maWcgdmFsdWUsIHdoaWNoIGlzIGFuIG9iamVjdCB3aXRoIGJvdGggdHJlYXRtZW50IGFuZCBjb25maWcgc3RyaW5nIGZvciB0aGUgZ2l2ZW4gZmVhdHVyZS5cbiAgICogQGZ1bmN0aW9uIGdldFRyZWF0bWVudFdpdGhDb25maWdcbiAgICogQHBhcmFtIHtTcGxpdEtleX0ga2V5IC0gVGhlIGtleSBmb3IgdGhlIGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHNwbGl0TmFtZSAtIFRoZSBzdHJpbmcgdGhhdCByZXByZXNlbnRzIHRoZSBzcGxpdCB3ZSB3YW50IHRvIGdldCB0aGUgdHJlYXRtZW50LlxuICAgKiBAcGFyYW0ge0F0dHJpYnV0ZXN9IGF0dHJpYnV0ZXMgLSBBbiBvYmplY3Qgb2YgdHlwZSBBdHRyaWJ1dGVzIGRlZmluaW5nIHRoZSBhdHRyaWJ1dGVzIGZvciB0aGUgZ2l2ZW4ga2V5LlxuICAgKiBAcmV0dXJucyB7VHJlYXRtZW50V2l0aENvbmZpZ30gLSBUaGUgbWFwIGNvbnRhaW5pbmcgdGhlIHRyZWF0bWVudCBhbmQgdGhlIGNvbmZpZ3VyYXRpb24gc3RyaW5naWZpZWQgSlNPTiAob3IgbnVsbCBpZiB0aGVyZSB3YXMgbm8gY29uZmlnIGZvciB0aGF0IHRyZWF0bWVudCkuXG4gICAqL1xuICBnZXRUcmVhdG1lbnRXaXRoQ29uZmlnKGtleTogU3BsaXRJTy5TcGxpdEtleSwgc3BsaXROYW1lOiBzdHJpbmcsIGF0dHJpYnV0ZXM/OiBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQpOiBTcGxpdElPLlRyZWF0bWVudFdpdGhDb25maWc7XG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgVHJlYXRtZW50V2l0aENvbmZpZyB2YWx1ZSwgd2hpY2ggaXMgYW4gb2JqZWN0IHdpdGggYm90aCB0cmVhdG1lbnQgYW5kIGNvbmZpZyBzdHJpbmcgZm9yIHRoZSBnaXZlbiBmZWF0dXJlLlxuICAgKiBAZnVuY3Rpb24gZ2V0VHJlYXRtZW50V2l0aENvbmZpZ1xuICAgKiBAcGFyYW0ge3N0cmluZ30gc3BsaXROYW1lIC0gVGhlIHN0cmluZyB0aGF0IHJlcHJlc2VudHMgdGhlIHNwbGl0IHdlIHdhbnQgdG8gZ2V0IHRoZSB0cmVhdG1lbnQuXG4gICAqIEBwYXJhbSB7QXR0cmlidXRlc30gYXR0cmlidXRlcyAtIEFuIG9iamVjdCBvZiB0eXBlIEF0dHJpYnV0ZXMgZGVmaW5pbmcgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAqIEByZXR1cm5zIHtUcmVhdG1lbnRXaXRoQ29uZmlnfSAtIFRoZSBtYXAgY29udGFpbmluZyB0aGUgdHJlYXRtZW50IGFuZCB0aGUgY29uZmlndXJhdGlvbiBzdHJpbmdpZmllZCBKU09OIChvciBudWxsIGlmIHRoZXJlIHdhcyBubyBjb25maWcgZm9yIHRoYXQgdHJlYXRtZW50KS5cbiAgICovXG4gIGdldFRyZWF0bWVudFdpdGhDb25maWcoc3BsaXROYW1lOiBzdHJpbmcsIGF0dHJpYnV0ZXM/OiBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQpOiBTcGxpdElPLlRyZWF0bWVudFdpdGhDb25maWc7XG4gIGdldFRyZWF0bWVudFdpdGhDb25maWcocGFyYW0xOiBzdHJpbmcgfCBTcGxpdElPLlNwbGl0S2V5LCBwYXJhbTI/OiBzdHJpbmcgfCBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQsIHBhcmFtMz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50V2l0aENvbmZpZyB7XG4gICAgY29uc3Qge2tleSwgc3BsaXROYW1lcywgYXR0cmlidXRlc30gPSBwYXJzZVRyZWF0bWVudFBhcmFtcyhwYXJhbTEsIHBhcmFtMiwgcGFyYW0zKTtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnQoa2V5KS5nZXRUcmVhdG1lbnRXaXRoQ29uZmlnKHNwbGl0TmFtZXMsIGF0dHJpYnV0ZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBUcmVhdG1lbnRzIHZhbHVlLCB3aGljaCBpcyBhbiBvYmplY3QgbWFwIHdpdGggdGhlIHRyZWF0bWVudHMgZm9yIHRoZSBnaXZlbiBmZWF0dXJlcy5cbiAgICogQGZ1bmN0aW9uIGdldFRyZWF0bWVudHNcbiAgICogQHBhcmFtIHtTcGxpdEtleX0ga2V5IC0gVGhlIGtleSBmb3IgdGhlIGNsaWVudCBpbnN0YW5jZS5cbiAgICogQHBhcmFtIHtBcnJheTxzdHJpbmc+fSBzcGxpdE5hbWVzIC0gQW4gYXJyYXkgb2YgdGhlIHNwbGl0IG5hbWVzIHdlIHdhbnQgdG8gZ2V0IHRoZSB0cmVhdG1lbnRzLlxuICAgKiBAcGFyYW0ge0F0dHJpYnV0ZXM9fSBhdHRyaWJ1dGVzIC0gQW4gb2JqZWN0IG9mIHR5cGUgQXR0cmlidXRlcyBkZWZpbmluZyB0aGUgYXR0cmlidXRlcyBmb3IgdGhlIGdpdmVuIGtleS5cbiAgICogQHJldHVybnMge1RyZWF0bWVudHN9IC0gVGhlIHRyZWF0bWVudHMgb2JqZWN0IG1hcC5cbiAgICovXG4gIGdldFRyZWF0bWVudHMoa2V5OiBTcGxpdElPLlNwbGl0S2V5LCBzcGxpdE5hbWVzOiBzdHJpbmdbXSwgYXR0cmlidXRlcz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50cztcbiAgLyoqXG4gICAqIFJldHVybnMgYSBUcmVhdG1lbnRzIHZhbHVlLCB3aGljaCBpcyBhbiBvYmplY3QgbWFwIHdpdGggdGhlIHRyZWF0bWVudHMgZm9yIHRoZSBnaXZlbiBmZWF0dXJlcy5cbiAgICogQGZ1bmN0aW9uIGdldFRyZWF0bWVudHNcXFxuICAgKiBAcGFyYW0ge0FycmF5PHN0cmluZz59IHNwbGl0TmFtZXMgLSBBbiBhcnJheSBvZiB0aGUgc3BsaXQgbmFtZXMgd2Ugd2FudCB0byBnZXQgdGhlIHRyZWF0bWVudHMuXG4gICAqIEBwYXJhbSB7QXR0cmlidXRlcz19IGF0dHJpYnV0ZXMgLSBBbiBvYmplY3Qgb2YgdHlwZSBBdHRyaWJ1dGVzIGRlZmluaW5nIHRoZSBhdHRyaWJ1dGVzIGZvciB0aGUgZ2l2ZW4ga2V5LlxuICAgKiBAcmV0dXJucyB7VHJlYXRtZW50c30gLSBUaGUgdHJlYXRtZW50cyBvYmplY3QgbWFwLlxuICAgKi9cbiAgZ2V0VHJlYXRtZW50cyhzcGxpdE5hbWVzOiBzdHJpbmdbXSwgYXR0cmlidXRlcz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50cztcbiAgZ2V0VHJlYXRtZW50cyhwYXJhbTE6IHN0cmluZ1tdIHwgU3BsaXRJTy5TcGxpdEtleSwgcGFyYW0yPzogc3RyaW5nW10gfCBTcGxpdElPLkF0dHJpYnV0ZXMgfCB1bmRlZmluZWQsIHBhcmFtMz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50cyB7XG4gICAgY29uc3Qge2tleSwgc3BsaXROYW1lcywgYXR0cmlidXRlc30gPSBwYXJzZVRyZWF0bWVudFBhcmFtcyhwYXJhbTEsIHBhcmFtMiwgcGFyYW0zKTtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnQoa2V5KS5nZXRUcmVhdG1lbnRzKHNwbGl0TmFtZXMsIGF0dHJpYnV0ZXMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBUcmVhdG1lbnRzV2l0aENvbmZpZyB2YWx1ZSwgd2hpY2ggaXMgYW4gb2JqZWN0IG1hcCB3aXRoIHRoZSBUcmVhdG1lbnRXaXRoQ29uZmlnIChhbiBvYmplY3Qgd2l0aCBib3RoIHRyZWF0bWVudCBhbmQgY29uZmlnIHN0cmluZykgZm9yIHRoZSBnaXZlbiBmZWF0dXJlcy5cbiAgICogQGZ1bmN0aW9uIGdldFRyZWF0bWVudHNXaXRoQ29uZmlnXG4gICAqIEBwYXJhbSB7U3BsaXRLZXl9IGtleSAtIFRoZSBrZXkgZm9yIHRoZSBjbGllbnQgaW5zdGFuY2UuXG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gc3BsaXROYW1lcyAtIEFuIGFycmF5IG9mIHRoZSBzcGxpdCBuYW1lcyB3ZSB3YW50IHRvIGdldCB0aGUgdHJlYXRtZW50cy5cbiAgICogQHBhcmFtIHtBdHRyaWJ1dGVzPX0gYXR0cmlidXRlcyAtIEFuIG9iamVjdCBvZiB0eXBlIEF0dHJpYnV0ZXMgZGVmaW5pbmcgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAqIEByZXR1cm5zIHtUcmVhdG1lbnRzV2l0aENvbmZpZ30gVGhlIG1hcCB3aXRoIGFsbCB0aGUgVHJlYXRtZW50V2l0aENvbmZpZyBvYmplY3RzXG4gICAqL1xuICBnZXRUcmVhdG1lbnRzV2l0aENvbmZpZyhrZXk6IFNwbGl0SU8uU3BsaXRLZXksIHNwbGl0TmFtZXM6IHN0cmluZ1tdLCBhdHRyaWJ1dGVzPzogU3BsaXRJTy5BdHRyaWJ1dGVzIHwgdW5kZWZpbmVkKTogU3BsaXRJTy5UcmVhdG1lbnRzV2l0aENvbmZpZztcbiAgLyoqXG4gICAqIFJldHVybnMgYSBUcmVhdG1lbnRzV2l0aENvbmZpZyB2YWx1ZSwgd2hpY2ggaXMgYW4gb2JqZWN0IG1hcCB3aXRoIHRoZSBUcmVhdG1lbnRXaXRoQ29uZmlnIChhbiBvYmplY3Qgd2l0aCBib3RoIHRyZWF0bWVudCBhbmQgY29uZmlnIHN0cmluZykgZm9yIHRoZSBnaXZlbiBmZWF0dXJlcy5cbiAgICogQGZ1bmN0aW9uIGdldFRyZWF0bWVudHNXaXRoQ29uZmlnXG4gICAqIEBwYXJhbSB7QXJyYXk8c3RyaW5nPn0gc3BsaXROYW1lcyAtIEFuIGFycmF5IG9mIHRoZSBzcGxpdCBuYW1lcyB3ZSB3YW50IHRvIGdldCB0aGUgdHJlYXRtZW50cy5cbiAgICogQHBhcmFtIHtBdHRyaWJ1dGVzPX0gYXR0cmlidXRlcyAtIEFuIG9iamVjdCBvZiB0eXBlIEF0dHJpYnV0ZXMgZGVmaW5pbmcgdGhlIGF0dHJpYnV0ZXMgZm9yIHRoZSBnaXZlbiBrZXkuXG4gICAqIEByZXR1cm5zIHtUcmVhdG1lbnRzV2l0aENvbmZpZ30gVGhlIG1hcCB3aXRoIGFsbCB0aGUgVHJlYXRtZW50V2l0aENvbmZpZyBvYmplY3RzXG4gICAqL1xuICBnZXRUcmVhdG1lbnRzV2l0aENvbmZpZyhzcGxpdE5hbWVzOiBzdHJpbmdbXSwgYXR0cmlidXRlcz86IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCk6IFNwbGl0SU8uVHJlYXRtZW50c1dpdGhDb25maWc7XG4gIGdldFRyZWF0bWVudHNXaXRoQ29uZmlnKHBhcmFtMTogc3RyaW5nW10gfCBTcGxpdElPLlNwbGl0S2V5LCBwYXJhbTI/OiBzdHJpbmdbXSB8IFNwbGl0SU8uQXR0cmlidXRlcyB8IHVuZGVmaW5lZCwgcGFyYW0zPzogU3BsaXRJTy5BdHRyaWJ1dGVzIHwgdW5kZWZpbmVkKTogU3BsaXRJTy5UcmVhdG1lbnRzV2l0aENvbmZpZyB7XG4gICAgY29uc3Qge2tleSwgc3BsaXROYW1lcywgYXR0cmlidXRlc30gPSBwYXJzZVRyZWF0bWVudFBhcmFtcyhwYXJhbTEsIHBhcmFtMiwgcGFyYW0zKTtcbiAgICByZXR1cm4gdGhpcy5nZXRDbGllbnQoa2V5KS5nZXRUcmVhdG1lbnRzV2l0aENvbmZpZyhzcGxpdE5hbWVzLCBhdHRyaWJ1dGVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFja3MgYW4gZXZlbnQgZm9yIGEgc2hhcmVkIGNsaWVudCB0byBiZSBmZWQgdG8gdGhlIHJlc3VsdHMgcHJvZHVjdCBvbiBTcGxpdCBXZWJjb25zb2xlIGFuZCByZXR1cm5zIGEgcHJvbWlzZSB0byBzaWduYWwgd2hlbiB0aGUgZXZlbnQgd2FzIHN1Y2Nlc3NmdWxseSBxdWV1ZWQgKG9yIG5vdCkuXG4gICAqIEBmdW5jdGlvbiB0cmFja1xuICAgKiBAcGFyYW0ge1NwbGl0S2V5fSBrZXkgLSBUaGUga2V5IHRoYXQgaWRlbnRpZmllcyB0aGUgZW50aXR5IHJlbGF0ZWQgdG8gdGhpcyBldmVudC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IHRyYWZmaWNUeXBlIC0gVGhlIHRyYWZmaWMgdHlwZSBvZiB0aGUgZW50aXR5IHJlbGF0ZWQgdG8gdGhpcyBldmVudC5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGV2ZW50VHlwZSAtIFRoZSBldmVudCB0eXBlIGNvcnJlc3BvbmRpbmcgdG8gdGhpcyBldmVudC5cbiAgICogQHBhcmFtIHtudW1iZXI9fSB2YWx1ZSAtIFRoZSB2YWx1ZSBvZiB0aGlzIGV2ZW50LlxuICAgKiBAcGFyYW0ge1Byb3BlcnRpZXM9fSBwcm9wZXJ0aWVzIC0gVGhlIHByb3BlcnRpZXMgb2YgdGhpcyBldmVudC4gVmFsdWVzIGNhbiBiZSBzdHJpbmcsIG51bWJlciwgYm9vbGVhbiBvciBudWxsLlxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxib29sZWFuPn0gQSBwcm9taXNlIHRoYXQgcmVzb2x2ZXMgdG8gYSBib29sZWFuIGluZGljYXRpbmcgaWYgdGhlIGV2ZW50IHdhcyBhZGRlZCB0byB0aGUgcXVldWUgc3VjY2Vzc2Z1bGx5IG9yIG5vdC5cbiAgICovXG4gIHRyYWNrKGtleTogU3BsaXRJTy5TcGxpdEtleSwgdHJhZmZpY1R5cGU6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyIHwgdW5kZWZpbmVkLCBwcm9wZXJ0aWVzPzogU3BsaXRJTy5Qcm9wZXJ0aWVzIHwgdW5kZWZpbmVkKTogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFRyYWNrcyBhbiBldmVudCB0byBiZSBmZWQgdG8gdGhlIHJlc3VsdHMgcHJvZHVjdCBvbiBTcGxpdCBXZWJjb25zb2xlIGFuZCByZXR1cm5zIGEgcHJvbWlzZSB0byBzaWduYWwgd2hlbiB0aGUgZXZlbnQgd2FzIHN1Y2Nlc3NmdWxseSBxdWV1ZWQgKG9yIG5vdCkuXG4gICAqIEBmdW5jdGlvbiB0cmFja1xuICAgKiBAcGFyYW0ge3N0cmluZ30gdHJhZmZpY1R5cGUgLSBUaGUgdHJhZmZpYyB0eXBlIG9mIHRoZSBlbnRpdHkgcmVsYXRlZCB0byB0aGlzIGV2ZW50LlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZXZlbnRUeXBlIC0gVGhlIGV2ZW50IHR5cGUgY29ycmVzcG9uZGluZyB0byB0aGlzIGV2ZW50LlxuICAgKiBAcGFyYW0ge251bWJlcj19IHZhbHVlIC0gVGhlIHZhbHVlIG9mIHRoaXMgZXZlbnQuXG4gICAqIEBwYXJhbSB7UHJvcGVydGllcz19IHByb3BlcnRpZXMgLSBUaGUgcHJvcGVydGllcyBvZiB0aGlzIGV2ZW50LiBWYWx1ZXMgY2FuIGJlIHN0cmluZywgbnVtYmVyLCBib29sZWFuIG9yIG51bGwuXG4gICAqIEByZXR1cm5zIHtQcm9taXNlPGJvb2xlYW4+fSBBIHByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhIGJvb2xlYW4gaW5kaWNhdGluZyBpZiB0aGUgZXZlbnQgd2FzIGFkZGVkIHRvIHRoZSBxdWV1ZSBzdWNjZXNzZnVsbHkgb3Igbm90LlxuICAgKi9cbiAgdHJhY2sodHJhZmZpY1R5cGU6IHN0cmluZywgZXZlbnRUeXBlOiBzdHJpbmcsIHZhbHVlPzogbnVtYmVyIHwgdW5kZWZpbmVkLCBwcm9wZXJ0aWVzPzogU3BsaXRJTy5Qcm9wZXJ0aWVzIHwgdW5kZWZpbmVkKTogYm9vbGVhbjtcbiAgdHJhY2socGFyYW0xOiBzdHJpbmcgfCBTcGxpdElPLlNwbGl0S2V5LCBwYXJhbTI6IHN0cmluZywgcGFyYW0zPzogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkLCBwYXJhbTQ/OiBudW1iZXIgfCBTcGxpdElPLlByb3BlcnRpZXMgfCB1bmRlZmluZWQsIHBhcmFtNT86IFNwbGl0SU8uUHJvcGVydGllcyB8IHVuZGVmaW5lZCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHtrZXksIHRyYWZmaWNUeXBlLCBldmVudFR5cGUsIHZhbHVlLCBwcm9wZXJ0aWVzfSA9IHBhcnNlVHJhY2tQYXJhbXMocGFyYW0xLCBwYXJhbTIsIHBhcmFtMywgcGFyYW00LCBwYXJhbTUpO1xuICAgIHJldHVybiB0aGlzLmdldENsaWVudChrZXkpLnRyYWNrKHRyYWZmaWNUeXBlLCBldmVudFR5cGUsIHZhbHVlLCBwcm9wZXJ0aWVzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMga2V5IGFuZCByZXR1cm5zIGNsaWVudCBpZiBpdCBpcyBpbml0aWFsaXplZCBmb3Iga2V5IG9yIGNvbnRyb2xDbGllbnQgaWYgaXQgaXNuJ3RcbiAgICovXG4gIHByaXZhdGUgZ2V0TWFuYWdlcigpIHtcbiAgICBjb25zdCBjbGllbnQgPSB0aGlzLmdldFNES0NsaWVudCgpO1xuICAgIGlmICghY2xpZW50KSB7XG4gICAgICBjb25zb2xlLmxvZygnW0VSUk9SXSBUaGUgU0RLIGhhcyBub3QgYmVpbmcgaW5pdGlhbGl6ZWQuIFJldHVybmluZyBkZWZhdWx0IHJlc3BvbnNlIGZvciBtZXRob2QgY2FsbC4nKTtcbiAgICAgIHJldHVybiBERUZBVUxUX01BTkFHRVI7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnNwbGl0TWFuYWdlcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFycmF5IG9mIHNwbGl0cyBkYXRhIGluIFNwbGl0VmlldyBmb3JtYXQuXG4gICAqIEBmdW5jdGlvbiBnZXRTcGxpdHNcbiAgICogQHJldHVybnMge1NwbGl0Vmlld3N9IFRoZSBsaXN0IG9mIFNwbGl0SU8uU3BsaXRWaWV3LlxuICAgKi9cbiAgZ2V0U3BsaXRzKCk6IFNwbGl0SU8uU3BsaXRWaWV3cyB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0TWFuYWdlcigpLnNwbGl0cygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgZGF0YSBvZiBhIHNwbGl0IGluIFNwbGl0VmlldyBmb3JtYXQuXG4gICAqIEBmdW5jdGlvbiBnZXRTcGxpdFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3BsaXROYW1lIFRoZSBuYW1lIG9mIHRoZSBzcGxpdCB3ZSB3YW4ndCB0byBnZXQgaW5mbyBvZi5cbiAgICogQHJldHVybnMge1NwbGl0Vmlld30gVGhlIFNwbGl0SU8uU3BsaXRWaWV3IG9mIHRoZSBnaXZlbiBzcGxpdC5cbiAgICovXG4gIGdldFNwbGl0KHNwbGl0TmFtZTogc3RyaW5nKTogU3BsaXRJTy5TcGxpdFZpZXcgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5nZXRNYW5hZ2VyKCkuc3BsaXQoc3BsaXROYW1lKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGFycmF5IG9mIFNwbGl0IG5hbWVzLlxuICAgKiBAZnVuY3Rpb24gZ2V0U3BsaXROYW1lc1xuICAgKiBAcmV0dXJucyB7U3BsaXROYW1lc30gVGhlIGxpc3RzIG9mIFNwbGl0IG5hbWVzLlxuICAgKi9cbiAgZ2V0U3BsaXROYW1lcygpOiBTcGxpdElPLlNwbGl0TmFtZXMge1xuICAgIHJldHVybiB0aGlzLmdldE1hbmFnZXIoKS5uYW1lcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3kgYWxsIGNsaWVudHMgaW5zdGFuY2VzLlxuICAgKiBAZnVuY3Rpb24gZGVzdHJveVxuICAgKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTx1bmtub3duPn1cbiAgICovXG4gIGRlc3Ryb3koKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgY29uc3QgbWFpbkluc3RhbmNlS2V5ID0gYnVpbGRJbnN0YW5jZSh0aGlzLmNvbmZpZy5jb3JlLmtleSk7XG4gICAgdGhpcy5jbGllbnRzTWFwLmZvckVhY2goKGNsaWVudCwga2V5KSA9PiB7XG4gICAgICBpZiAoYnVpbGRJbnN0YW5jZShrZXkpICE9PSBtYWluSW5zdGFuY2VLZXkpe1xuICAgICAgICBjbGllbnQuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmNsaWVudHNNYXAuZGVsZXRlKGJ1aWxkSW5zdGFuY2Uoa2V5KSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5jbGllbnRzTWFwLmRlbGV0ZShtYWluSW5zdGFuY2VLZXkpO1xuICAgIHRoaXMuc3BsaXRpbyA9IHVuZGVmaW5lZDtcbiAgICByZXR1cm4gZnJvbSh0aGlzLnNwbGl0Q2xpZW50LmRlc3Ryb3koKSk7XG4gIH1cblxuICAvKipcbiAgICogUHJpdmF0ZSBmdW5jdGlvbiB0byByZXR1cm4gYXMgb2JzZXJ2YWJsZSB0aGUgZXZlbnQgb24gcGFyYW1ldGVyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBldmVudFxuICAgKiBAcGFyYW0gcmVzcG9uc2VcbiAgICogQHJldHVybnMgT2JzZXJ2YWJsZTxhbnk+XG4gICAqL1xuICBwcml2YXRlIHRvT2JzZXJ2YWJsZShrZXk6IFNwbGl0SU8uU3BsaXRLZXksIGNsaWVudDogU3BsaXRJTy5JQ2xpZW50LCBldmVudDogc3RyaW5nLCBpc09uZVRpbWVFdmVudCA9IHRydWUpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGNvbnN0IGV2ZW50S2V5ID0gYnVpbGRJbnN0YW5jZShrZXkpICsgZXZlbnQ7XG4gICAgaWYgKGlzT25lVGltZUV2ZW50KSB7XG4gICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoc3Vic2NyaWJlciA9PiB7XG4gICAgICAgIGNvbnN0IHdhc0V2ZW50RW1pdHRlZCA9IHRoaXMuZW1pdHRlZEV2ZW50cy5nZXQoZXZlbnRLZXkpO1xuICAgICAgICBpZiAod2FzRXZlbnRFbWl0dGVkKSB7XG4gICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBzdWJzY3JpYmVyLm5leHQoZXZlbnQpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjbGllbnQub25jZShldmVudCwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbWl0dGVkRXZlbnRzLnNldChldmVudEtleSwgdHJ1ZSk7XG4gICAgICAgICAgICBzdWJzY3JpYmVyLm5leHQoZXZlbnQpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKHN1YnNjcmliZXIgPT4ge1xuICAgICAgICBjbGllbnQub24oZXZlbnQsICgpID0+IHtcbiAgICAgICAgICBzdWJzY3JpYmVyLm5leHQoZXZlbnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG59XG4iXX0=